<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Рух товарів</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/main.js}"></script>
</head>
<body>

<h1>Рух товарів</h1>

<!-- Show "Back" button if the user has LOADER role -->
<div class="button-bar" th:if="${role == 'LOADER'}">
    <a href="/loader"><button class="first">Назад</button></a>
</div>

<!-- Show "Back" button if the user has MANAGER role -->
<div class="button-bar" th:if="${role == 'MANAGER'}">
    <a href="/manager"><button class="first">Назад</button></a>
</div>

<!-- Feedback messages (success or error) -->
<div th:if="${param.success}" class="message success">Рух товару успішно зареєстровано!</div>
<div th:if="${error}" class="message error">
    <span th:text="${error}"></span>
</div>

<!-- Movement registration form (visible only for LOADER role) -->
<div th:if="${role == 'LOADER'}" id="movementForm" class="card">
    <h2>Зареєструвати рух товару</h2>

    <!-- Form submits new movement record -->
    <form th:action="@{/add}" th:object="${movement}" method="post">

        <select th:field="*{item}" required>
            <option value="">— Оберіть товар —</option>
            <option th:each="i : ${items}" th:value="${i.item_id}" th:text="${i.name}"></option>
        </select>

        <select name="movement_type" th:field="*{movement_type}" required id="movementType">
            <option value="">— Оберіть тип руху —</option>
            <option value="IN">Прихід (оприбуткування)</option>
            <option value="OUT">Видаток (списання)</option>
            <option value="TRANSFER">Переміщення</option>
        </select>

        <!-- Fields shown only for TRANSFER movement type -->
        <div id="transferFields" style="display:none;">
            <!-- Select origin location -->
            <select name="fromLocation">
                <option value="">— Оберіть звідки перемістити —</option>
                <option th:each="loc : ${locations}" th:value="${loc.location_id}"
                        th:text="${loc.rack + '-' + loc.level + '-' + loc.position}"></option>
            </select>

            <!-- Select destination location -->
            <select name="toLocation">
                <option value="">— Оберіть куди перемістити —</option>
                <option th:each="loc : ${locations}" th:value="${loc.location_id}"
                        th:text="${loc.rack + '-' + loc.level + '-' + loc.position}"></option>
            </select>
        </div>

        <!-- Single location used for IN or OUT movement -->
        <div id="singleLocation">
            <select name="location">
                <option value="">— Оберіть локацію —</option>
                <option th:each="l : ${locations}" th:value="${l.location_id}"
                        th:text="${l.rack + '-' + l.level + '-' + l.position}"></option>
            </select>
        </div>

        <!-- Quantity input -->
        <input type="number" th:field="*{quantity}" placeholder="Кількість" min="1" required>

        <button type="submit" class="second">Зареєструвати рух</button>
    </form>
</div>

<div class="card">
    <h2>Історія рухів товарів</h2>

    <input type="text" id="searchInput" class="search-bar" placeholder="Пошук...">

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Товар</th>
            <th>Кількість</th>
            <th>Тип руху</th>
            <th>Локація</th>
            <th>Дата</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="m : ${movements}">
            <td th:text="${m.movement_id}"></td>
            <td th:text="${m.item.name}"></td>
            <td th:text="${m.quantity}"></td>
            <td th:text="${m.movement_type}"></td>

            <!-- Show location or '-' if null -->
            <td th:text="${m.location != null ? m.location.rack + '-' + m.location.level + '-' + m.location.position : '-'}"></td>
            <td th:text="${#temporals.format(m.date, 'yyyy-MM-dd HH:mm')}"></td>
        </tr>

        <!-- Fallback when there are no movements -->
        <tr th:if="${#lists.isEmpty(movements)}">
            <td colspan="6" class="no-data">Даних не знайдено</td>
        </tr>
        </tbody>
    </table>
</div>

</body>
</html>