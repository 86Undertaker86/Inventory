<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–†—É—Ö —Ç–æ–≤–∞—Ä—ñ–≤</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<h1>–†—É—Ö —Ç–æ–≤–∞—Ä—ñ–≤</h1>

<!-- üîπ –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
<div class="button-bar" th:if="${role == 'LOADER'}">
    <a href="/loader"><button class="first">‚¨Ö –ù–∞–∑–∞–¥</button></a>
</div>
<div class="button-bar" th:if="${role == 'MANAGER'}">
    <a href="/manager"><button class="first">‚¨Ö –ù–∞–∑–∞–¥</button></a>
</div>

<!-- üîπ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
<div th:if="${param.success}" class="message success">–†—É—Ö —Ç–æ–≤–∞—Ä—É —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ!</div>
<div th:if="${error}" class="message error">
    ‚ö†Ô∏è <span th:text="${error}"></span>
</div>

<!-- üîπ –§–æ—Ä–º–∞ —Ä—É—Ö—É (–ª–∏—à–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞) -->
<div th:if="${role == 'LOADER'}" id="movementForm" class="card">
    <h2>–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ —Ä—É—Ö —Ç–æ–≤–∞—Ä—É</h2>
    <form th:action="@{/add}" th:object="${movement}" method="post">

        <select th:field="*{item}" required>
            <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä ‚Äî</option>
            <option th:each="i : ${items}" th:value="${i.item_id}" th:text="${i.name}"></option>
        </select>

        <select name="movement_type" th:field="*{movement_type}" required id="movementType">
            <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Ä—É—Ö—É ‚Äî</option>
            <option value="IN">–ü—Ä–∏—Ö—ñ–¥ (–æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω–Ω—è)</option>
            <option value="OUT">–í–∏–¥–∞—Ç–æ–∫ (—Å–ø–∏—Å–∞–Ω–Ω—è)</option>
            <option value="TRANSFER">–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</option>
        </select>

        <!-- üîÅ –ü–æ–ª—è –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è -->
        <div id="transferFields" style="display:none;">
            <select name="fromLocation">
                <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å –∑–≤—ñ–¥–∫–∏ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ ‚Äî</option>
                <option th:each="loc : ${locations}" th:value="${loc.location_id}"
                        th:text="${loc.rack + '-' + loc.level + '-' + loc.position}"></option>
            </select>

            <select name="toLocation">
                <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å –∫—É–¥–∏ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ ‚Äî</option>
                <option th:each="loc : ${locations}" th:value="${loc.location_id}"
                        th:text="${loc.rack + '-' + loc.level + '-' + loc.position}"></option>
            </select>
        </div>

        <!-- üì¶ –î–ª—è IN / OUT -->
        <div id="singleLocation">
            <select name="location">
                <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é ‚Äî</option>
                <option th:each="l : ${locations}" th:value="${l.location_id}"
                        th:text="${l.rack + '-' + l.level + '-' + l.position}"></option>
            </select>
        </div>

        <input type="number" th:field="*{quantity}" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å"  min="1" required>

        <button type="submit" class="second">üíæ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ —Ä—É—Ö</button>
    </form>
</div>

<!-- üîπ –¢–∞–±–ª–∏—Ü—è —ñ—Å—Ç–æ—Ä—ñ—ó —Ä—É—Ö—ñ–≤ -->
<div class="card">
    <h2>–Ü—Å—Ç–æ—Ä—ñ—è —Ä—É—Ö—ñ–≤ —Ç–æ–≤–∞—Ä—ñ–≤</h2>
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>–¢–æ–≤–∞—Ä</th>
            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th>–¢–∏–ø —Ä—É—Ö—É</th>
            <th>–õ–æ–∫–∞—Ü—ñ—è</th>
            <th>–î–∞—Ç–∞</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="m : ${movements}">
            <td th:text="${m.movement_id}"></td>
            <td th:text="${m.item.name}"></td>
            <td th:text="${m.quantity}"></td>
            <td th:text="${m.movement_type}"></td>
            <td th:text="${m.location != null ? m.location.rack + '-' + m.location.level + '-' + m.location.position : '-'}"></td>
            <td th:text="${#temporals.format(m.date, 'yyyy-MM-dd HH:mm')}"></td>
        </tr>
        </tbody>
    </table>
</div>

<!-- ‚öôÔ∏è –°–∫—Ä–∏–ø—Ç–∏ -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const typeSelect = document.getElementById("movementType");
        const transferFields = document.getElementById("transferFields");
        const singleLocation = document.getElementById("singleLocation");

        function updateVisibility() {
            if (!typeSelect) return;
            if (typeSelect.value === "TRANSFER") {
                transferFields.style.display = "block";
                singleLocation.style.display = "none";
            } else {
                transferFields.style.display = "none";
                singleLocation.style.display = "block";
            }
        }

        if (typeSelect) {
            typeSelect.addEventListener("change", updateVisibility);
            updateVisibility();
        }

        // ‚è≥ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        const alerts = document.querySelectorAll('.message');
        alerts.forEach(alert => {
            setTimeout(() => alert.classList.add('fade-out'), 3000);
            setTimeout(() => alert.remove(), 4000);
        });

        // üîó –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑ URL
        if (window.location.search) {
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }
    });
</script>

</body>
</html>